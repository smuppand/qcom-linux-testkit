metadata:
  format: Lava-Test Test Definition 1.0
  name: Video_V4L2_With_Secrets
  description: "Run Video V4L2 runner; use LAVA secrets for Wi-Fi; auto-args for kodiak vs lemans/monaco; run base & overlay"
  maintainer:
    - smuppand@qti.qualcomm.com
  os:
    - openembedded
  scope:
    - functional

run:
  steps:
    - cd Runner
    - export REPO_ROOT="$PWD"
    - export TARGET="${TARGET:-}" # expected values: kodiak | lemans | monaco (case-insensitive)

    # Read Wi-Fi credentials from LAVA-provided secrets (exported as env vars in the job)
    - export SSID="${LAVA_WIFI_SSID:-}"
    - export PASSWORD="${LAVA_WIFI_PASSWORD:-}"

    # Build args for run.sh based on TARGET; always pass secrets; add downstream FW only for kodiak
    - |
      RPATH="$REPO_ROOT/suites/Multimedia/Video/Video_V4L2_Runner/run.sh"
      RESFILE="$REPO_ROOT/suites/Multimedia/Video/Video_V4L2_Runner/Video_V4L2_Runner.res"
      ARGS=""
      TL="$(printf '%s' "${TARGET:-}" | tr '[:upper:]' '[:lower:]')"
      case "$TL" in
        kodiak)
          ARGS="$ARGS --platform kodiak --app /data/vendor/iris_test_app/iris_v4l2_test --ssid \"$SSID\" --password \"$PASSWORD\" --downstream-fw /data/vendor/iris_test_app/vpu20_p1_gen2.mbn"
          ;;
        lemans)
          ARGS="$ARGS --platform lemans --ssid \"$SSID\" --password \"$PASSWORD\"" --app /data/vendor/iris_test_app/iris_v4l2_test
          ;;
        monaco)
          ARGS="$ARGS --platform monaco --ssid \"$SSID\" --password \"$PASSWORD\"" --app /data/vendor/iris_test_app/iris_v4l2_test
          ;;
        *)
          # Unknown or not provided: still pass secrets; platform autodetect in run.sh
          ARGS="$ARGS --ssid \"$SSID\" --password \"$PASSWORD\""
          ;;
      esac
      echo "TARGET=${TARGET:-unset} ARGS=$ARGS"

      # Run base (upstream) then overlay (downstream)
      # shellcheck disable=SC2086
      sh -lc "$RPATH --stack base $ARGS" || true
      "$REPO_ROOT/utils/send-to-lava.sh" "$RESFILE" || true

      # shellcheck disable=SC2086
      sh -lc "$RPATH --stack overlay $ARGS" || true
      "$REPO_ROOT/utils/send-to-lava.sh" "$RESFILE" || true

      # Optional roll-up (ignored if absent)
      "$REPO_ROOT/utils/result_parse.sh" || true
